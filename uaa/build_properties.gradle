import org.eclipse.jgit.storage.file.FileRepositoryBuilder
import org.eclipse.jgit.revwalk.RevWalk
import java.text.SimpleDateFormat

buildscript {
  repositories {
    mavenCentral()
  }

  dependencies {
    classpath group: 'org.eclipse.jgit', name: 'org.eclipse.jgit', version: '3.4.1.201406201815-r'
  }
}

task mainOutputResourcesDir {
    sourceSets.main.output.resourcesDir.mkdirs()
}

task gitInfo {
    dependsOn mainOutputResourcesDir

    def builder = new FileRepositoryBuilder()
    def repository = builder.findGitDir(projectDir).build()
    def objectId = repository.resolve("HEAD")
    def commit = new RevWalk(repository).parseCommit(objectId)

    def props = new Properties()
    props.setProperty("git.commit.id.abbrev", commit.getId().getName().substring(0,7))
    props.setProperty("git.commit.time", new SimpleDateFormat("yyyy-MM-dd'T'HH:mm:ssZ").format(commit.getAuthorIdent().getWhen()))

    props.store(new FileOutputStream("${sourceSets.main.resources.srcDirs.find()}/git.properties"), "DO NOT EDIT. This is generated file.")
}

task buildInfo {
    dependsOn mainOutputResourcesDir

    def props = new Properties()
    props.setProperty("build.version", version)
    props.store(new FileOutputStream("${sourceSets.main.resources.srcDirs.find()}/build.properties"), "DO NOT EDIT. This is generated file.")
}

processResources.dependsOn gitInfo, buildInfo
