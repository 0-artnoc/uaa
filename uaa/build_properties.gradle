import org.eclipse.jgit.storage.file.FileRepositoryBuilder
import org.eclipse.jgit.revwalk.RevWalk
import java.text.SimpleDateFormat

buildscript {
  repositories {
    mavenCentral()
  }

  dependencies {
    classpath group: 'org.eclipse.jgit', name: 'org.eclipse.jgit', version: '3.4.1.201406201815-r'
  }
}

task mainOutputResourcesDir {
    sourceSets.main.output.resourcesDir.mkdirs()
}

task gitInfo {
    dependsOn mainOutputResourcesDir
    myProps = System.properties
    gitSearchDir = projectDir
    if ( myProps !=null && null != myProps.getProperty('dot.git.directory') ) {
      gitSearchDir = new File(myProps.getProperty('dot.git.directory'))
    }

    def props = new Properties()

    if ( gitSearchDir.exists() ) {
      try {
          def builder = new FileRepositoryBuilder(gitSearchDir)
          def repository = builder.findGitDir(projectDir).build()
          def objectId = repository.resolve("HEAD")
          def commit = new RevWalk(repository).parseCommit(objectId)
          props.setProperty("git.commit.id.abbrev", commit.getId().getName().substring(0,7))
          props.setProperty("git.commit.time", new SimpleDateFormat("yyyy-MM-dd'T'HH:mm:ssZ").format(commit.getAuthorIdent().getWhen()))
      } catch (e) {
        props.setProperty("git.commit.id.abbrev", "failure-git-properties-not-found")
        props.setProperty("git.commit.time", new SimpleDateFormat("yyyy-MM-dd'T'HH:mm:ssZ").format(new java.util.Date()))
      }
    } else {
      props.setProperty("git.commit.id.abbrev", "unknown-git-directory-not-found")
      props.setProperty("git.commit.time", new SimpleDateFormat("yyyy-MM-dd'T'HH:mm:ssZ").format(new java.util.Date()))
    }

    props.store(new FileOutputStream("${sourceSets.main.resources.srcDirs.find()}/git.properties"), "DO NOT EDIT. This is generated file.")
}

task buildInfo {
    dependsOn mainOutputResourcesDir

    def props = new Properties()
    props.setProperty("build.version", version)
    props.store(new FileOutputStream("${sourceSets.main.resources.srcDirs.find()}/build.properties"), "DO NOT EDIT. This is generated file.")
}

processResources.dependsOn gitInfo, buildInfo
